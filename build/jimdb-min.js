/**
 * jimdb - v0.0.1 - 2014-06-12
 * 
 *
 * Copyright (c) 2014 Bastian Kr√ºger
 * Licensed MIT <https://raw.githubusercontent.com/basilikum/jimdb/master/LICENSE>
 */
!function(a,b){function c(a){return a.toString().replace(/^\s+/,"").replace(/\s+$/,"")}function d(a){return"number"==typeof a&&!isNaN(a)&&a>-1/0&&1/0>a?a:""+a}function e(a){this.$$model=a,this.$$items={},this.$$handler={add:[],remove:[],beforeAdd:[],beforeRemove:[]}}function f(a,b,c){this.name=a,this.related=c,this.model=b,f.verifyName(a)}function g(a,b){f.call(this,"",a,!1),this.name="pk",this.relatedField=b}function h(a,b,c,d){var e=c.model;if(f.call(this,a,b,!0),!(b instanceof r))throw'required property "model" not set correctly; Model expected';this.relatedField=c,this.resolve=d,this.relatedModel=e}function i(a,b,c){f.call(this,a,b,!0),i.verfiyData(c),this.relatedModel=w[c.relatedModel],this.resolve=c.resolveForward,this.optional=!!c.optional,this.relatedField=new h(b.name.toLowerCase()+"_set",this.relatedModel,this,c.resolveBackward),this.relatedModel.fields.push(this.relatedField)}function j(a,b,c,d){var e=c.model;if(f.call(this,a,b,!0),!(b instanceof r))throw'required property "model" not set correctly; Model expected';this.relatedField=c,this.resolve=d,this.relatedModel=e}function k(a,b,c){f.call(this,a,b,!0),k.verfiyData(c),this.relatedModel=w[c.relatedModel],this.resolve=c.resolveForward,this.relatedField=new j(b.name.toLowerCase()+"_set",this.relatedModel,this,c.resolveBackward),this.relatedModel.fields.push(this.relatedField)}function l(a,b,c,d){var e=c.model;if(f.call(this,a,b,!0),!(b instanceof r))throw'required property "model" not set correctly; Model expected';this.relatedField=c,this.resolve=d,this.relatedModel=e}function m(a,b,c){f.call(this,a,b,!0),m.verfiyData(c),this.relatedModel=w[c.relatedModel],this.resolve=c.resolveForward,this.optional=!!c.optional,this.relatedField=new l(b.name.toLowerCase(),this.relatedModel,this,c.resolveBackward),this.relatedModel.fields.push(this.relatedField)}function n(a,b,c){f.call(this,a,b,!1),n.verfiyData(c),this.optional=!!c.optional,this.primary=!!c.primary,this.maxLength=c.maxLength||1/0}function o(a,b,c){f.call(this,a,b,!1),o.verfiyData(c),this.optional=!!c.optional,this.primary=!!c.primary,this.maxValue=x.has(c,"maxValue")?c.maxValue:1/0,this.minValue=x.has(c,"minValue")?c.minValue:-1/0}function p(a,b,c){f.call(this,a,b,!1),p.verfiyData(c),this.optional=!!c.optional}function q(a,b,c){var d=b.name;b.init(c),x.has(a,d)&&(c[d]=a[d])}function r(a,b){var c=this;this.name=r.validateName(a),this.fields=t(b,this),this.items={},this.pkName=x.filter(this.fields,function(a){return a.primary===!0})[0].name,this.constructor=function(a){var b,d=this;if(Item.call(this,c),b=a[c.pkName],x.has(c.items,b))throw'An instance of "'+c.name+'" with the primary key "'+b+'" is already in use';return x.each(c.fields,function(b){q(a,b,d)}),c.items[b]=d,d},this.constructor.prototype=Object.create(Item.prototype),this.constructor.prototype.constructor=this.constructor}function s(a,b){this.constr=a,this.data=b}function t(a,b){var c=u(a,b);return v(c),c}function u(a,b){var c,d;return c=x.map(a,function(a,c){return new a.constr(c,b,a.data)}),c.sort(function(a,b){return a.primary&&!b.primary?-1:!a.primary&&b.primary?1:0}),d=x.filter(c,function(a){return a.primary===!0}),x.each(d,function(a){c.push(new g(b,a))}),c}function v(a){var b,c,d;if(b=x.count(a,function(a){return!(a instanceof f)}),c=x.count(a,function(a){return a.primary===!0}),d=x.isUnique(a,function(a){return a.name}),b>0)throw"Fieldset can only contain Field instances!";if(0===c)throw"Fieldset must have a primary field!";if(c>1)throw"Fieldset can only have one primary field!";if(!d)throw"Fieldset cannot contain field with the same name"}var w={},x=function(){function a(a,b){var c,d,e;if(m(a))for(c=0,d=a.length;d>c;c++)b(a[c],c,a);else{if(!n(a))throw"cannot iterate "+a.toString()+" of type "+typeof a;for(e in a)k(a,e)&&b(a[e],e,a)}}function c(b,c){var d=[];return a(b,function(){d.push(c.apply(this,arguments))}),d}function d(a){return c(a,function(a){return a})}function e(b,c){var d=0;return a(b,function(){c.apply(this,arguments)&&(d+=1)}),d}function f(b,c){var d=[];return a(b,function(a){c.apply(this,arguments)&&d.push(a)}),d}function g(b,c){var d=Array.prototype.slice.call(arguments,2);a(b,function(a){a.apply(c,d)})}function h(a,b){var c,d;if(m(a)){for(c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1}throw"cannot use indexOf on non Array value"}function i(a,b){var c,d,e;if(m(a)){for(c=0,d=a.length;d>c;c++)if(b(a[c],c,a))return a[c]}else{if(!n(a))throw"cannot iterate "+a.toString()+" of type "+typeof a;for(e in a)if(k(a,e)&&b(a[e],e,a))return a[e]}}function j(a,b){var c;if(m(a))return h(a,b)>-1;if(n(a))for(c in a)if(k(a,c)&&a[c]===b)return!0;return!1}function k(a,c){if(null===a||a===b)throw"Cannot convert undefined or null to object";return Object.prototype.hasOwnProperty.call(a,c)}function l(b,c){var d={},e=!0;return a(b,function(){var a=c.apply(this,arguments);d[a]&&(e=!1),d[a]=!0}),e}function m(a){return"[object Array]"===Object.prototype.toString.call(a)}function n(a){var b=typeof a;return"object"===b&&null!==a||"function"===b}function o(a){return"function"==typeof a}function p(a){return"[object Boolean]"===Object.prototype.toString.call(a)}function q(a){return r(a)&&a>0}function r(a){return"[object Number]"===Object.prototype.toString.call(a)&&a%1===0}function s(a){return a instanceof Date&&!isNaN(a.getTime())}function t(a){return"[object String]"===Object.prototype.toString.call(a)}return{each:a,map:c,values:d,count:e,filter:f,invokeEach:g,indexOf:h,find:i,contains:j,has:k,isUnique:l,isArray:m,isObject:n,isFunction:o,isBoolean:p,isInt:r,isPositiveInt:q,isDate:s,isString:t}}();e.prototype.toArray=function(){return x.values(this.$$items)},e.prototype.on=function(a,b){x.has(this.$$handler,a)&&this.$$handler[a].push(b)},e.prototype.add=function(a){var b,c;if(a instanceof this.$$model.constructor){if(x.contains(this.$$items,a))return;b=a,c=a[this.$$model.pkName]}else{if(c=d(a),x.has(this.$$items,a))return;b=this.$$model.items[c]||null}x.invokeEach(this.$$handler.beforeAdd,null,c,b,this),this.$$items[c]=b,x.invokeEach(this.$$handler.add,null,c,b,this)},e.prototype.remove=function(a){var b,c;if(a instanceof this.$$model.constructor){if(!x.contains(this.$$items,a))return;b=a,c=a[this.$$model.pkName]}else{if(!x.has(this.$$items,a))return;c=d(a),b=this.$$items[c]}x.invokeEach(this.$$handler.beforeRemove,null,c,b,this),delete this.$$items[c],x.invokeEach(this.$$handler.remove,null,c,b,this)},f.verifyName=function(a){if("pk"===a)throw'Cannot use reserved word "pk" as field name'},f.prototype.verify=function(){return!0},f.prototype.sanitize=function(a){return a},f.prototype.set=function(a,b){a["$$"+this.name]=b},f.prototype.get=function(a){return a["$$"+this.name]},f.prototype.getDefault=function(){return""},f.prototype.addGetterSetter=function(a){var b=this;Object.defineProperty(a,b.name,{get:function(){return b.get(a)},set:function(c){return b.set(a,c)}})},f.prototype.init=function(a){this.initFlat(a)},f.prototype.initFlat=function(a){a[this.name]=this.getDefault(a)},f.prototype.initGetSet=function(a){a["$$"+this.name]=this.getDefault(a),this.addGetterSetter(a)},f.prototype.initRelated=function(a){this.initGetSet(a),a["$$"+this.name+"_rel"]={pk:null,resolved:!1}},g.prototype=Object.create(f.prototype),g.prototype.constructor=g,g.prototype.get=function(a){return this.relatedField.related?a["$$"+this.relatedField.name+"_rel"].pk:a[this.relatedField.name]},g.prototype.set=function(){return!1},g.prototype.init=function(a){this.addGetterSetter(a)},h.prototype=Object.create(f.prototype),h.prototype.constructor=h,h.prototype.set=function(){return!1},h.prototype.getDefault=function(a){var b,c=this;return b=new e(c.relatedModel),b.on("beforeAdd",function(a,b){if(b){var d=b["$$"+c.relatedField.name];d&&d[c.name].remove(b)}}),b.on("add",function(b,d){d&&(d["$$"+c.relatedField.name]=a,d["$$"+c.relatedField.name+"_rel"]={pk:a[c.model.pkName],resolved:!0})}),b.on("remove",function(a,b){b&&(b["$$"+c.relatedField.name]=null,b["$$"+c.relatedField.name+"_rel"]={pk:null,resolved:!0})}),b},h.prototype.init=function(a){this.initGetSet(a)},i.verfiyData=function(a){if(!(w[a.relatedModel]instanceof r))throw'no model with the name "'+a.relatedModel+'" defined';if(!x.isFunction(a.resolveForward))throw'required property "resolveForward" not set correctly; function expected';if(!x.isFunction(a.resolveBackward))throw'required property "resolveBackward" not set correctly; function expected';if(x.has(a,"optional")&&!x.isBoolean(a.optional))throw'optional property "optional" not set correctly; boolean value expected'},i.prototype=Object.create(f.prototype),i.prototype.constructor=i,i.prototype.verify=function(a){return a instanceof this.relatedModel.constructor||this.optional&&(a===b||null===a)?!0:!1},i.prototype.set=function(a,b){var c,d=null,e=a["$$"+this.name];b instanceof this.relatedModel.constructor?(d=b,c=d[this.relatedModel.pkName]):(d=this.relatedModel.items[b]||null,c=b),e&&e!==d&&e[this.relatedField.name].remove(a),a["$$"+this.name]=d,a["$$"+this.name+"_rel"]={pk:c,resolved:!!d},d&&d[this.relatedField.name].add(a)},i.prototype.getDefault=function(){return null},i.prototype.init=function(a){this.initRelated(a)},j.prototype=Object.create(f.prototype),j.prototype.constructor=j,j.prototype.set=function(){return!1},j.prototype.getDefault=function(a){var b,c=this;return b=new e(c.relatedModel),b.on("add",function(b,d){d&&d["$$"+c.relatedField.name].add(a)}),b.on("remove",function(b,d){d&&d["$$"+c.relatedField.name].remove(a)}),b},j.prototype.init=function(a){this.initGetSet(a)},k.verfiyData=function(a){if(!(w[a.relatedModel]instanceof r))throw'no model with the name "'+a.relatedModel+'" defined';if(!x.isFunction(a.resolveForward))throw'required property "resolveForward" not set correctly; function expected';if(!x.isFunction(a.resolveBackward))throw'required property "resolveBackward" not set correctly; function expected'},k.prototype=Object.create(f.prototype),k.prototype.constructor=k,k.prototype.verify=function(a){var b=this;return x.isArray(a)?x.every(a,function(a){return a instanceof b.relatedModel.constructor}):!1},k.prototype.set=function(){return!1},k.prototype.getDefault=function(a){var b,c=this;return b=new e(c.relatedModel),b.on("add",function(b,d){d&&d["$$"+c.relatedField.name].add(a)}),b.on("remove",function(b,d){d&&d["$$"+c.relatedField.name].remove(a)}),b},k.prototype.init=function(a){this.initGetSet(a)},l.prototype=Object.create(f.prototype),l.prototype.constructor=l,l.prototype.set=function(a,b){var c,d=null,e=a["$$"+this.name];if(b instanceof this.relatedModel.constructor?(d=b,c=d[this.relatedModel.pkName]):(d=this.relatedModel.items[b]||null,c=b),e){if(e===d)return;e["$$"+this.relatedField.name]=null,e["$$"+this.relatedField.name+"_rel"]={pk:null,resolved:!0}}a["$$"+this.name]=d,a["$$"+this.name+"_rel"]={pk:c,resolved:!!d},d&&(d[this.relatedField.name]=a)},l.prototype.getDefault=function(){return null},l.prototype.init=function(a){this.initRelated(a)},m.verfiyData=function(a){if(!(w[a.relatedModel]instanceof r))throw'no model with the name "'+a.relatedModel+'" defined';if(!x.isFunction(a.resolveForward))throw'required property "resolveForward" not set correctly; function expected';if(!x.isFunction(a.resolveBackward))throw'required property "resolveBackward" not set correctly; function expected';if(x.has(a,"optional")&&!x.isBoolean(a.optional))throw'optional property "optional" not set correctly; boolean value expected'},m.prototype=Object.create(f.prototype),m.prototype.constructor=m,m.prototype.verify=function(a){return a instanceof this.relatedModel.constructor||this.optional&&(a===b||null===a)?!0:!1},m.prototype.set=function(a,b){var c,d=null,e=a["$$"+this.name];if(b instanceof this.relatedModel.constructor?(d=b,c=d[this.relatedModel.pkName]):(d=this.relatedModel.items[b]||null,c=b),e){if(e===d)return;e["$$"+this.relatedField.name]=null,e["$$"+this.relatedField.name+"_rel"]={pk:null,resolved:!0}}a["$$"+this.name]=d,a["$$"+this.name+"_rel"]={pk:c,resolved:!!d},d&&(d[this.relatedField.name]=a)},m.prototype.getDefault=function(){return null},m.prototype.init=function(a){this.initRelated(a)},n.verfiyData=function(a){if(x.has(a,"primary")&&!x.isBoolean(a.primary))throw'optional property "primary" not set correctly; boolean value expected';if(x.has(a,"optional")&&!x.isBoolean(a.optional))throw'optional property "optional" not set correctly; boolean value expected';if(a.optional&&a.primary)throw"primary fields can never be optional";if(x.has(a,"maxLength")&&!x.isPositiveInt(a.maxLength))throw'optional property "maxLength" not set correctly; positive integer value expected'},n.prototype=Object.create(f.prototype),n.prototype.constructor=n,n.prototype.verify=function(a){return a=c(a),x.isString(a)&&a.length<=this.maxLength&&a.length>0||this.optional&&(a===b||null===a||""===a)?!0:!1},n.prototype.sanitize=function(a){return a.toString().trim()},n.prototype.getDefault=function(){return""},n.prototype.init=function(a){this.initFlat(a)},o.verfiyData=function(a){var b,c;if(x.has(a,"primary")&&!x.isBoolean(a.primary))throw'optional property "primary" not set correctly; boolean value expected';if(x.has(a,"optional")&&!x.isBoolean(a.optional))throw'optional property "optional" not set correctly; boolean value expected';if(a.optional&&a.primary)throw"primary fields can never be optional";if(b=x.has(a,"maxValue"),c=x.has(a,"minValue"),b&&!x.isInt(a.maxValue))throw'optional property "maxValue" not set correctly; integer value expected';if(c&&!x.isInt(a.minValue))throw'optional property "minValue" not set correctly; integer value expected';if(b&&c&&a.minValue>=a.maxValue)throw'optional property "minValue" must be smaller than optional property "maxValue"'},o.prototype=Object.create(f.prototype),o.prototype.constructor=o,o.prototype.verify=function(a){return x.isInt(a)&&a<=this.maxValue&&a>=this.minValue||this.optional&&(a===b||null===a)?!0:!1},o.prototype.sanitize=function(a){return parseInt(a,10)},o.prototype.getDefault=function(){return 0},o.prototype.init=function(a){this.initFlat(a)},p.verfiyData=function(a){if(x.has(a,"optional")&&!x.isBoolean(a.optional))throw'optional property "optional" not set correctly; boolean value expected'},p.prototype=Object.create(f.prototype),p.prototype.constructor=p,p.prototype.verify=function(a){return x.isDate(a)||this.optional&&(a===b||null===a)?!0:!1},p.prototype.sanitize=function(a){return a instanceof Date?a:new Date(a)},p.prototype.getDefault=function(){return new Date},p.prototype.init=function(a){this.initFlat(a)},r.validateName=function(a){if(!x.isString(a)||0===a.length)throw"model name must a string with a length > 0";return a},r.StringField=function(a){return new s(n,a)},a.$M={define:function(a,b){if(x.has(w,a))throw'a model with the name "'+a+'" is already registered';var c=new r(a,b);return w[a]=c,c.constructor},OneToManyField:function(a){return{constr:i,data:a}},ManyToManyField:function(a){return{constr:k,data:a}},OneToOneField:function(a){return{constr:m,data:a}},StringField:function(a){return{constr:n,data:a}},IntegerField:function(a){return{constr:o,data:a}},DateField:function(a){return{constr:p,data:a}}}}(window);